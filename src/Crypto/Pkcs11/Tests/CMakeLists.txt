cmake_minimum_required(VERSION 3.14)

if(FLAME_TESTING)
	set(NAME "Pkcs11.Tests")
	set(NAME_ALIAS "Pkcs11::Tests")
	set(INCLUDE_PATHS
		${FLAME_INCLUDE_PATH}
		${FLAME_INCLUDE_TEST_PATH}
	)
	get_sources(FILE_LIST)
	list(FILTER FILE_LIST EXCLUDE REGEX "main.cpp")

	set(DEPENDENCY_HEADER_TARGETS
		"${FLAME_NAMESPACE}::Os::Headers"
		"${FLAME_NAMESPACE}::Os::${FLAME_PLATFORM}::Headers"
		"${FLAME_NAMESPACE}::Crypto::Pkcs11::Headers"
	)

	set(STATIC_ALIAS_NAME "${FLAME_NAMESPACE}::${NAME_ALIAS}::Static")
	set(SHARED_ALIAS_NAME "${FLAME_NAMESPACE}::${NAME_ALIAS}::Shared")
	set(SHARED_LIBRARY_DIR_DEFINE "SHARED_LIBRARY_DIRECTORY=\"${FLAME_ROOT_BINARY_DIR}\"")

	set(MAIN_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/main.cpp")
	if(FLAME_MAKE_STATIC)
		set(MAKE_STATIC MAKE_STATIC)
		flame_compile_binary(
			NAME "${NAME}.static"
			SOURCE_LIST "${MAIN_SOURCE}"
			#INSTALL_PATH
			INCLUDE_PATHS "${INCLUDE_PATHS}"
			#HEADER_LIST
			#COMMPILE_FLAGS
			#LINK_FLAGS"
			DEPENDENCY_TARGET_LIST "${STATIC_ALIAS_NAME}"
			DEFINES "${SHARED_LIBRARY_DIR_DEFINE}"

			NO_RTTI
			EXCEPTIONS

			TEST
			TEST_ARGUMENTS ""
		)
	endif()
	if(FLAME_MAKE_SHARED)
		set(MAKE_SHARED MAKE_SHARED)
		flame_compile_binary(
			NAME "${NAME}.shared"
			SOURCE_LIST "${MAIN_SOURCE}"
			#INSTALL_PATH
			INCLUDE_PATHS "${INCLUDE_PATHS}"
			#HEADER_LIST
			#COMMPILE_FLAGS"
			#LINK_FLAGS"
			DEPENDENCY_TARGET_LIST "${SHARED_ALIAS_NAME}"
			DEFINES "${SHARED_LIBRARY_DIR_DEFINE}"

			NO_RTTI
			EXCEPTIONS

			TEST
			TEST_ARGUMENTS ""
		)
	endif()

	set(DEPENDENCY_TARGETS_FOR_STATIC
		"${FLAME_NAMESPACE}::Os::Static"
		"${FLAME_NAMESPACE}::Crypto::Pkcs11::Static"
	)
	set(DEPENDENCY_TARGETS_FOR_SHARED
		"${FLAME_NAMESPACE}::Os::Shared"
		"${FLAME_NAMESPACE}::Crypto::Pkcs11::Shared"
	)

	flame_compile_library(
		NAME "${NAME}"
		SOURCE_LIST "${FILE_LIST}"
		INCLUDE_PATHS "${INCLUDE_PATHS}"
		DEPENDENCY_HEADER_TARGETS     "${DEPENDENCY_HEADER_TARGETS}"
		DEPENDENCY_TARGETS_FOR_STATIC "${DEPENDENCY_TARGETS_FOR_STATIC}"
		DEPENDENCY_TARGETS_FOR_SHARED "${DEPENDENCY_TARGETS_FOR_SHARED}"
		OBJECT_ALIAS_NAME "${FLAME_NAMESPACE}::${NAME_ALIAS}::Object"
		INDEPENDENT_OBJECT_ALIAS_NAME
			"${FLAME_NAMESPACE}::${NAME_ALIAS}::Object::Independ"
		STATIC_ALIAS_NAME "${STATIC_ALIAS_NAME}"
		SHARED_ALIAS_NAME "${SHARED_ALIAS_NAME}"

		DEFINES "${SHARED_LIBRARY_DIR_DEFINE}"

		NO_RTTI
		EXCEPTIONS

		${MAKE_STATIC}
		${MAKE_SHARED}
	)

endif()
